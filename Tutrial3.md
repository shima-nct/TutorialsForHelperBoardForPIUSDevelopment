# CAN通信

## CAN通信とは

### 物理層

### Layer 1（物理層）

#### CAN通信の電気的特性

信号振幅、差動電圧レベル、アイドル／アクティブ状態（ドミナント／リセッシブ）など

#### 平衡線路による伝送、CAN_H と CAN_L

差動対線（ツイストペア）の使用

#### トランシーバー（TX と RX）

電気‐機械的インタフェースの入出力

#### #### ドミナントとリセッシブ

バス電圧状態による論理 “0／1” の表現

シグナルコーディング、NRZ
ノンリターン・トゥ・ゼロ方式によるビット伝送

#### 通信速度

ボーレート（最高 1 Mbps など）の設定

### Layer 2（データリンク層）

#### コントローラー

フレーミング、エラーチェック、再送制御などのロジック

#### CANバスとノード、マルチ・マスター方式

ネットワークトポロジーと任意ノードからの送信許可

#### バスの調停、CSMA/CA

ビット単位アービトレーションを含むアクセス制御

#### 同期、同期がずれた場合の調整の仕組み、ビットスタフィング

ビット同期維持（同期ビット／ビットスタッフィング）

 #### エラー検出

CANのデータリンク層（リンクレイヤー）にはビットモニタリングと ACK チェックのほかに、以下の３つのエラー検出機構が規定されており、合計５種類のメカニズムが存在します。

1. ビットモニタリング（Bit Monitoring）
送信ビットとバス上のビットを逐次比較し、不一致を検出する。

1. スタッフィングエラー（Stuff Error）
連続する同一ビットが５つを越えたときに挿入する“ビットスタッフィング”ルールの違反を検出する。

1. フレームフォーマットエラー（Form Error）
SOF／EOF／CRC デリミタなど、定義された固定ビットパターンが破られたときに検出する。 
Total Phase

1. CRC エラー（CRC Error）
受信側で再計算した CRC と送信側の CRC フィールドを比較し、不一致を検出する。

1. ACK チェック（Acknowledgement Check）
ACK スロットで受信ノードのドミナント応答が得られないときに検出する。

これらにより、ビットレベル／メッセージレベル双方で堅牢なエラー検出が実現されています。

 #### 封じ込め（Error Detection and Error Confinement）

CANプロトコルでは、異常ノードを自動的に排除する仕組みとして 「フォルトコンフィンメント機構（Error Confinement Mechanism）」 が定義されています。
この機構では各ノードが送受信エラーを検出すると内部のエラーカウンタ（TEC＝Transmit Error Counter、REC＝Receive Error Counter）を増減し、以下の３つの状態を自律的に遷移します。

1. Error Active
正常動作中の状態。エラー検出時には「アクティブエラーフレーム」を送出し、他ノードに通知。

1. Error Passive
軽微なエラーが累積した状態。エラー検出時には「パッシブエラーフレーム」を送出し、バスへの影響を最小限に抑制。

1. Bus-Off
重大なエラーが連続（TEC≥256）すると到達し、この状態ではノードはバスから完全に切り離され、以降通信に参加しなくなる 
Medium。

これにより、悪影響を及ぼす異常ノードをネットワークから排除し、システム全体の信頼性を維持します。

#### データの構造、データフレームとリモートフレーム

CANのデータフレーム（標準フォーマット／拡張フォーマット）は、以下のようなフィールド順・ビット構成で構成されています。

---

##### 1. 標準フォーマット（11bit ID）

| フィールド名                | ビット長 | 概要                                        |
| --------------------- | ---- | ----------------------------------------- |
| SOF                   | 1    | フレーム開始ビット（Dominant=0）                     |
| **Arbitration Field** |      |                                           |
| • Identifier          | 11   | メッセージ識別子                                  |
| • RTR                 | 1    | リモート送信要求ビット（Data Frame→0, Remote Frame→1） |
| • IDE                 | 1    | フォーマット識別（標準→0, 拡張→1）                      |
| • r0                  | 1    | 予備ビット（予約）                                 |
| **Control Field**     |      |                                           |
| • DLC                 | 4    | データ長コード（Data Length Code：0～8 バイト）         |
| **Data Field**        | 0–64 | 実データ（0～8 バイト×8bit=0～64bit）                |
| **CRC Field**         |      |                                           |
| • CRC Sequence        | 15   | CRC 検査値                                   |
| • CRC Delimiter       | 1    | CRC デリミタ（Recessive=1）                     |
| **ACK Field**         |      |                                           |
| • ACK Slot            | 1    | 受信ノードによる “Dominant=0” 応答                  |
| • ACK Delimiter       | 1    | ACK デリミタ（Recessive=1）                     |
| **EOF**               | 7    | フレーム終了ビット（全て Recessive=1）                 |
| **IFS**               | 3    | インターミッション（次フレームとの隙間：Recessive=1 が3ビット）    |

---

##### 2. 拡張フォーマット（29bit ID）

標準フォーマットとの違いは Arbitration Field の拡張部分のみです。

| フィールド名                | ビット長 | 備考                                        |
| --------------------- | ---- | ----------------------------------------- |
| SOF                   | 1    | 同上                                        |
| **Arbitration Field** |      |                                           |
| • Identifier (High)   | 11   | ID の上位 11bit                              |
| • SRR                 | 1    | Substitute Remote Request（必ず Recessive=1） |
| • IDE                 | 1    | フォーマット識別（標準→0, 拡張→1）                      |
| • Identifier (Low)    | 18   | ID の下位 18bit                              |
| • RTR                 | 1    | 拡張フレーム中の RTR                              |
| • r1、r0               | 2    | 予約ビット                                     |
| **Control Field**     | 4    | DLC                                       |
| **Data Field**        | 0–64 | 実データ                                      |
| **CRC Field**         | 15+1 | 同上                                        |
| **ACK Field**         | 2    | 同上                                        |
| **EOF**               | 7    | 同上                                        |
| **IFS**               | 3    | 同上                                        |

---

以上が CAN データフレームのビット構成です。標準／拡張ともに、物理層での差動送受信に先立ってこのリンク層フォーマットに従ってフレームを組み立て・解析します。

#### データ構造の戦略

多くのノードが必要とする重要なデータはデータフレームを流し続けて、各ノードは必要に応じて受信するようにします。この場合、バス上に置かれた共有メモリにアクセスするようなイメージです。「回転寿司」に例えた説明もあります。

https://monoist.itmedia.co.jp/mn/articles/0807/09/news140_2.html

リモートフレームによる呼び出しで他のノードのデータをデータフレームで取得する方法は分散コンピューティングのリモートプロシジャーコール(RPC)のイメージです。先のページでは「オーダーしてから料理が運ばれてくるレストラン」に例えています。

CANの伝送レートは最大1Mbps（CAN FDの場合は2Mbps、5Mbpsなど1Mbps以上）ですが、オープンハードウェアのESC(Electric Speed Controller)だと500kbpsがよく用いられているようです。

対象とする制御系の制御周期を短くすると500kbps、1Mbpsだと1周期におけるデータ量はそれほど多くとれません。そのため、1周期間に置くデータは慎重に設計する必要があるでしょう。

## CAN通信における構成要素

### CANコントローラー

### CANトランシーバー

### コネクタ

### 線路

### 終端抵抗（ターミネーター）

## ArduinoとCAN通信

### Arduino公式のCANライブラリ

Arduino公式のボードでCANをサポートしているのはArduino Uno R4などのRenesasのMCUを採用したボードかMKR CAN Shieldのみです。前者の場合、MCU内蔵のCANコントローラーを用いることができますが、トランシーバーは別途用意する必要があります。後者はコントローラーMCP2515とトランシーバーTJA1049が搭載されているので直接CANバスに接続することができます。

ESP32シリーズのMCUにもCANコントローラーが内蔵されていますが、公式ライブラリとの互換性はないため別のライブラリを用いる必要があります。

https://docs.arduino.cc/learn/communication/can/
https://docs.arduino.cc/hardware/mkr-can-shield/

### ESP32 TWAI Driver

Espressif公式のArduino ESP32ドキュメントではTWAIについてはArduino APIでサポートされていないと述べられています。

https://docs.espressif.com/projects/arduino-esp32/en/latest/libraries.html

しかし、ESP32のボードライブラリに付属しているスケッチ例にはESP32>TWAI>TWAIreceive、TWAItransmitがあります。これらはESP32の公式SDKであるESP-IDFのペリフェラルドライバをそのまま呼び出しているようです。

このようにArduinoからの利用についてはサポート対象外とされていますが、Arduino APIと干渉しない限りではTWAI Driverを用いることでArduion ESP32でもTWAIを利用することができます。

https://github.com/espressif/arduino-esp32/tree/master/libraries/ESP32/examples/TWAI

## 課題

### 課題3

#### 課題3.1

二つのノードで以下の処理を100ms毎に行うスクリプトを実行し、エラー発生頻度を観察しなさい。
 
1. 32bitのカウントアップ
1. カウンターの値をデータフレームで発出
1. 他のノードの値を読み取る
1. 他のノードの読み取り値が飛び値だった場合は読み取りデータエラーを表示

#### 課題3.2

二つのノードで以下の処理を10ms毎に行うスクリプトを実行し、エラー発生頻度を観察しなさい。

1. ノード1ではスロットル開度の値を読み取りCANデータフレームとして発出する。
1. ノード2ではCANデータフレームからスロットル開度の値を読み取り、LEDディスプレイに表示する。

